<!DOCTYPE html> 
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ショップマップ（フィルター付き）</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
    }

    #map {
      width: 100%;
      height: 100vh;
    }

    #filter-toggle {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: white;
      border: 1px solid #ccc;
      padding: 10px 14px;
      cursor: pointer;
      font-size: 20px;
      border-radius: 12px; /* ← 丸みのある四角形 */
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      transition: background 0.3s ease;
    }

    #filter-toggle:hover {
      background: #f0f0f0;
    }

    #filter-panel {
      position: absolute;
      top: 60px;
      right: 10px;
      z-index: 999;
      background: rgba(255, 255, 255, 0.95);
      padding: 12px;
      border-radius: 8px;
      width: 90%;
      max-width: 320px;
      max-height: 0;
      overflow: hidden;
      opacity: 0;
      pointer-events: none;
      transition: max-height 0.3s ease, opacity 0.3s ease;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .filter-group h4 {
      font-size: 14px;
      margin: 0 0 5px;
    }

    .filter-group label {
      cursor: pointer;
      font-size: 15px;
      user-select: none;
      display: block;
      margin: 4px 0;
    }

    #keyword {
      width: 100%;
      padding: 8px;
      font-size: 15px;
      margin-top: 5px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    #clear-filters {
      padding: 8px 16px;
      font-size: 15px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: white;
      cursor: pointer;
      width: 100%;
      margin-top: 12px;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #clear-filters:hover {
      background: #f0f0f0;
    }
    #clear-filters i {
      margin-right: 6px;
      vertical-align: middle;
    }

    /* オートコンプリート候補リスト */
    #autocomplete-list {
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 150px;
      overflow-y: auto;
      width: 100%;
      z-index: 1100;
      box-sizing: border-box;
    }

    #autocomplete-list li {
      padding: 6px 10px;
      cursor: pointer;
    }

    #autocomplete-list li:hover {
      background-color: #007bff;
      color: white;
    }

    /* キーワード入力親要素をrelativeに */
    .filter-group.keyword-group {
      position: relative;
    }

    #filter-panel {
      position: absolute;
      top: 60px;
      right: 10px;
      z-index: 999;
      background: rgba(255, 255, 255, 0.95);
      padding: 12px;
      border-radius: 8px;
      width: 90%;
      max-width: 320px;

      max-height: 400px; /* 最大高さを設定 */
      overflow-y: auto;  /* 縦スクロールを許可 */

      opacity: 0;
      pointer-events: none;
      transition: max-height 0.3s ease, opacity 0.3s ease;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);

      display: block; /* グリッド解除して縦積みに */
    }

    /* フィルターグループは縦積み */
    .filter-group {
      margin-bottom: 16px;
    }

    /* タイトルは縦積みそのまま */
    .filter-group h4 {
      margin: 0 0 8px 0;
      font-size: 14px;
      font-weight: 600;
    }

    /* ラベル群は横並びで折り返し */
    .filter-group label {
      display: inline-flex;
      align-items: center;
      margin-right: 12px;
      margin-bottom: 6px;
      white-space: nowrap;
      cursor: pointer;
      user-select: none;
    }

  </style>
</head>
<body>

<!-- <script>
  let pw;
  do {
    pw = prompt("パスワードを入力してください:");
    if (pw === null) {  // キャンセルしたらページを離れるなど処理を追加
      alert("パスワード入力がキャンセルされました");
      window.location.href = "https://example.com";
      break;
    }
    if (pw !== "abc123") {
      alert("パスワードが違います。もう一度入力してください。");
    }
  } while (pw !== "abc123");
</script> -->


<div id="filter-toggle" title="フィルターを表示">
  <i class="fas fa-sliders-h"></i>
</div>

<div id="filter-panel">
  <div class="filter-group" id="genre-options">
    <h4>ジャンル</h4>
    <label><input type="checkbox" data-category="genre" value="居酒屋"> 居酒屋</label>
    <label><input type="checkbox" data-category="genre" value="焼き鳥"> 焼き鳥</label>
    <label><input type="checkbox" data-category="genre" value="海鮮"> 海鮮</label>
    <label><input type="checkbox" data-category="genre" value="立ち飲み"> 立ち飲み</label>
    <label><input type="checkbox" data-category="genre" value="イタリアン"> イタリアン</label>
    <label><input type="checkbox" data-category="genre" value="ビアガーデン"> ビアガーデン</label>
    <label><input type="checkbox" data-category="genre" value="バー"> バー</label>
    <label><input type="checkbox" data-category="genre" value="洋食"> 洋食</label>
    <label><input type="checkbox" data-category="genre" value="焼肉"> 焼肉</label>
    <label><input type="checkbox" data-category="genre" value="中華料理"> 中華料理</label>   
  </div>

  <div class="filter-group" id="scene-options">
    <h4>利用シーン</h4>
    <label><input type="checkbox" data-category="scene" value="大人数の宴会"> 大人数の宴会</label>
    <label><input type="checkbox" data-category="scene" value="デート・友人と"> デート・友人と</label>
    <label><input type="checkbox" data-category="scene" value="家族・子供と"> 家族・子供と</label>
    <label><input type="checkbox" data-category="scene" value="一人で入りやすい"> 一人で入りやすい</label>
    <label><input type="checkbox" data-category="scene" value="接待・大人の集まり"> 接待・大人の集まり</label>
    <label><input type="checkbox" data-category="scene" value="女子会"> 女子会</label>
  </div>

  <div class="filter-group" id="seat-options">
    <h4>席・設備</h4>
    <label><input type="checkbox" data-category="seat" value="貸切"> 貸切</label>
    <label><input type="checkbox" data-category="seat" value="個室"> 個室</label>
  </div>

  <div class="filter-group" id="course-options">
    <h4>コース</h4>
    <label><input type="checkbox" data-category="course" value="飲み放題"> 飲み放題</label>
    <label><input type="checkbox" data-category="course" value="食べ放題"> 食べ放題</label>
    <label><input type="checkbox" data-category="course" value="食べ飲み放題"> 食べ飲み放題</label>
  </div>

  <div class="filter-group" id="alcohol-options">
    <h4>ドリンク</h4>
    <label><input type="checkbox" data-category="alcohol" value="ザ・パーフェクト黒ラベル"> ザ・パーフェクト黒ラベル</label>
    <label><input type="checkbox" data-category="alcohol" value="神泡"> 神泡</label>
    <label><input type="checkbox" data-category="alcohol" value="エクストラコールド"> エクストラコールド</label>
    <label><input type="checkbox" data-category="alcohol" value="ヱビス"> ヱビス</label>
    <label><input type="checkbox" data-category="alcohol" value="地ビール"> 地ビール</label>
    <label><input type="checkbox" data-category="alcohol" value="地酒"> 地酒</label>
    <label><input type="checkbox" data-category="alcohol" value="日本酒"> 日本酒</label>
    <label><input type="checkbox" data-category="alcohol" value="焼酎"> 焼酎</label>
    <label><input type="checkbox" data-category="alcohol" value="ワイン"> ワイン</label>
  </div>


  <div class="filter-group keyword-group">
    <h4>キーワード</h4>
    <input type="text" id="keyword" placeholder="店名・住所" autocomplete="off" />
    <ul id="autocomplete-list" style="display:none;"></ul>
  </div>

  <button id="clear-filters"><i class="fas fa-undo"></i>すべて解除</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const map = L.map('map').setView([34.678, 135.160], 15);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let markers = [];

// ---------------------- 店舗データ ----------------------
const shops = [
  {
    "name": "新潟の地酒と銀しゃり 信",
    "address": "大阪府大阪市中央区南本町3-3-23 インペリアル船場ビル B1F",
    "lat": 34.686408,
    "lng": 135.501984,
    "genre": ["居酒屋", "海鮮"],
    "scene": ["家族・子供と", "一人で入りやすい"],
    "seat": ["貸切"],
    "course": ["飲み放題"],
    "alcohol": ["ザ・パーフェクト黒ラベル", "日本酒"],
    "url": "https://tabelog.com/osaka/A2701/A270106/27090438"
  },
  {
    "name": "とり禅",
    "address": "〒650-0004 兵庫県神戸市中央区中山手通1-9-2 MOZANビル 1F",
    "lat": 34.69561,
    "lng": 135.192221,
    "genre": ["焼き鳥", "居酒屋"],
    "scene": ["大人数の宴会", "デート・友人と"],
    "seat": ["個室", "貸切"],
    "course": ["飲み放題"],
    "alcohol": ["焼酎"],
    "url": "https://tabelog.com/hyogo/A2801/A280101/28028831"
  },
  {
  "name": "スタンド クラシック",
  "address": "兵庫県神戸市中央区北長狭通1-31-33",
  "lat": 34.692336,
  "lng": 135.19198,
  "genre": ["立ち飲み", "バー"],
  "scene": ["一人で入りやすい", "デート・友人と"],
  "seat": ["なし"],
  "course": ["なし"],
  "alcohol": ["ザ・パーフェクト黒ラベル", "日本酒"], 
  "url": "https://tabelog.com/hyogo/A2801/A280101/28048536/"
},
{
  "name": "スターボード",
  "address": "兵庫県神戸市中央区北長狭通2-7-12 pmptビル 2F",
  "lat": 34.692156,
  "lng": 135.189986,
  "genre": ["ビアガーデン", "イタリアン"],
  "scene": ["大人数の宴会", "デート・友人と", "一人で入りやすい"],
  "seat": ["なし"],
  "course": ["飲み放題", "食べ飲み放題"],
  "alcohol": ["地ビール"],
  "url": "https://tabelog.com/hyogo/A2801/A280101/28026306/"
},
{
  "name": "一夜一夜 神戸本店",
  "address": "兵庫県神戸市中央区中山手通1-9-12 Ｍ’Ｓビル １Ｆ",
  "lat": 34.695648,
  "lng": 135.191926,
  "genre": ["居酒屋", "海鮮"],
  "scene": ["接待・大人の集まり", "デート・友人と"],
  "seat": ["なし"],
  "course": ["飲み放題", "食べ放題", "食べ飲み放題"],
  "alcohol": ["日本酒", "地酒"],
  "url": "https://tabelog.com/hyogo/A2801/A280101/28000741/"
},
{
  "name": "食堂 丸山",
  "address": "兵庫県神戸市中央区下山手通8-15-1 ライオンズマンション神戸元町第三 1F",
  "lat": 34.687122,
  "lng": 135.17963,
  "genre": ["居酒屋", "海鮮"],
  "scene": ["接待・大人の集まり", "デート・友人と"],
  "seat": ["なし"],
  "course": ["飲み放題", "食べ放題", "食べ飲み放題"],
  "alcohol": ["日本酒", "地酒"],
  "url": "https://tabelog.com/hyogo/A2801/A280102/28067405/"
},
{
  "name": "ピンチョス 元町ヱビス",
  "address": "兵庫県神戸市中央区元町通1-11-13",
  "lat": 34.689827,
  "lng": 135.188831,
  "genre": ["ビアガーデン", "洋食"],
  "scene": ["家族・子供と", "デート・友人と", "一人で入りやすい"],
  "seat": ["貸切"],
  "course": ["飲み放題", "食べ放題", "食べ飲み放題"],
  "alcohol": ["ヱビス"],
  "url": "https://tabelog.com/hyogo/A2801/A280102/28001953/"
},
{
  "name": "エスプリ 三宮6Ｆ店",
  "address": "兵庫県神戸市中央区北長狭通1-2-18 三宮OSビル 6F",
  "lat": 34.694154,
  "lng": 135.193281,
  "genre": ["バー", "居酒屋"],
  "scene": ["大人数の宴会", "デート・友人と", "一人で入りやすい"],
  "seat": ["貸切"],
  "course": ["飲み放題"],
  "alcohol": ["カクテル"],
  "url": "https://tabelog.com/hyogo/A2801/A280101/28001618/"
},
{
  "name": "明石焼肉 MORISHIN 明石駅前店",
  "address": "兵庫県明石市大明石町1-6-1 パピオス明石 1F",
  "lat": 34.647975,
  "lng": 134.992024,
  "genre": ["焼肉"],
  "scene": ["家族・子供と", "デート・友人と"],
  "seat": ["貸切"],
  "course": ["飲み放題"],
  "alcohol": ["神泡"],
  "url": "https://tabelog.com/hyogo/A2804/A280401/28038708/"
},
{
  "name": "YAKINIKUEN 忍鬨 東心斎橋2号店",
  "address": "大阪府大阪市中央区東心斎橋1-7-10 アパホテルなんば心斎橋東 1F",
  "lat": 34.672802,
  "lng": 135.505043,
  "genre": ["焼肉"],
  "scene": ["家族・子供と"],
  "seat": ["なし"],
  "course": ["なし"],
  "alcohol": ["神泡"],
  "url": "https://tabelog.com/osaka/A2701/A270201/27128762/"
},
{
  "name": "但馬屋イーマ",
  "address": "大阪府大阪市北区梅田1-12-6 イーマ　５Ｆ",
  "lat": 34.700645,
  "lng": 135.498624,
  "genre": ["焼肉"],
  "scene": ["家族・子供と", "接待・大人の集まり", "デート・友人と"],
  "seat": ["個室"],
  "course": ["飲み放題"],
  "alcohol": ["日本酒", "ワイン"],
  "url": "https://tabelog.com/osaka/A2701/A270101/27040612/"
},
{
  "name": "四川曹家官府菜　蜀　（suu）",
  "address": "兵庫県神戸市中央区下山手通4-13-5 三木ビル",
  "lat": 34.692594,
  "lng": 135.18581,
  "genre": ["中華料理", "居酒屋"],
  "scene": ["家族・子供と", "一人で入りやすい", "デート・友人と"],
  "seat": ["個室","貸切"],
  "course": ["なし"],
  "alcohol": ["なし"],
  "url": "https://tabelog.com/hyogo/A2801/A280102/28023301/"
},
{
  "name": "すみび焼肉　Da-Wa",
  "address": "大阪府大阪市福島区福島7-8-3 福本ビル 3F",
  "lat": 34.696772,
  "lng": 135.485621,
  "genre": ["焼肉"],
  "scene": ["家族・子供と", "デート・友人と"],
  "seat": ["貸切"],
  "course": ["なし"],
  "alcohol": ["ワイン"],
  "url": "https://tabelog.com/osaka/A2701/A270108/27123777/"
},
{
  "name": "焼肉一丁 難波店",
  "address": "大阪府大阪市中央区難波3-1-25",
  "lat": 34.665787,
  "lng": 135.502224,
  "genre": ["焼肉"],
  "scene": ["接待・大人の集まり", "デート・友人と"],
  "seat": ["個室","貸切"],
  "course": ["なし"],
  "alcohol": ["ワイン"],
  "url": "https://tabelog.com/osaka/A2701/A270202/27020008/"
},
{
  "name": "酒と肴 SUIGEI",
  "address": "大阪府大阪市北区芝田1-7-2",
  "lat": 34.707354,
  "lng": 135.497981,
  "genre": ["海鮮","居酒屋"],
  "scene": ["接待・大人の集まり", "デート・友人と"],
  "seat": ["なし"],
  "course": ["なし"],
  "alcohol": ["神泡","日本酒"],
  "url": "https://tabelog.com/osaka/A2701/A270101/27108085/"
},
{
  "name": "中崎バール Switch",
  "address": "大阪府大阪市北区中崎西1-4-22 梅田東ビル1F",
  "lat": 34.706647,
  "lng": 135.503858,
  "genre": ["イタリアン"],
  "scene": ["女子会", "デート・友人と"],
  "seat": ["貸切"],
  "course": ["なし"],
  "alcohol": ["神泡","ワイン"],
  "url": "https://tabelog.com/osaka/A2701/A270101/27062704/"
},
{
  "name": "くずし割烹　ZUTTO",
  "address": "兵庫県神戸市垂水区平磯4-4-16 川本ビル 1F",
  "lat": 34.628912,
  "lng": 135.055324,
  "genre": ["居酒屋", "海鮮"],
  "scene": ["家族・子供と", "接待・大人の集まり", "デート・友人と"],
  "seat": ["貸切", "個室"],
  "course": ["飲み放題"],
  "alcohol": ["焼酎","日本酒"],
  "url": "https://tabelog.com/hyogo/A2801/A280110/28052878/"
},
{
  "name": "はらペコ屋 たま商店",
  "address": "岡山県岡山市北区岩田町2-31",
  "lat": 34.6693,
  "lng": 133.920934,
  "genre": ["居酒屋"],
  "scene": ["接待・大人の集まり", "デート・友人と"],
  "seat": ["個室"],
  "course": ["飲み放題"],
  "alcohol": ["なし"],
  "url": "https://tabelog.com/okayama/A3301/A330101/33018416/"
},
];

const selectedFilters = {
  genre: [],
  scene: [],
  seat: [],
  course: [],
  alcohol: [] 
};

const keywordInput = document.getElementById('keyword');
const filterToggle = document.getElementById('filter-toggle');
const filterPanel = document.getElementById('filter-panel');
const clearFiltersBtn = document.getElementById('clear-filters');
const autoCompleteList = document.getElementById('autocomplete-list');

// カスタムアイコンをジャンルごとに設定
const icons = {
  default: L.icon({
    iconUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png',
    shadowSize: [41, 41]
  }),
  // 他のジャンル用アイコンがあればここに追加（今回使わない）
};

filterToggle.addEventListener('click', () => {
  if (filterPanel.style.maxHeight && filterPanel.style.maxHeight !== '0px') {
    filterPanel.style.maxHeight = '0';
    filterPanel.style.opacity = '0';
    filterPanel.style.pointerEvents = 'none';
  } else {
    filterPanel.style.maxHeight = filterPanel.scrollHeight + 'px';
    filterPanel.style.opacity = '1';
    filterPanel.style.pointerEvents = 'auto';
  }
});

document.querySelectorAll('#filter-panel input[type="checkbox"]').forEach(checkbox => {
  checkbox.addEventListener('change', () => {
    selectedFilters.genre = Array.from(document.querySelectorAll('input[data-category="genre"]:checked')).map(cb => cb.value);
    selectedFilters.scene = Array.from(document.querySelectorAll('input[data-category="scene"]:checked')).map(cb => cb.value);
    selectedFilters.seat = Array.from(document.querySelectorAll('input[data-category="seat"]:checked')).map(cb => cb.value);
    selectedFilters.course = Array.from(document.querySelectorAll('input[data-category="course"]:checked')).map(cb => cb.value);
    selectedFilters.alcohol = Array.from(document.querySelectorAll('input[data-category="alcohol"]:checked')).map(cb => cb.value);
    updateMarkers();
  });
});

keywordInput.addEventListener('input', () => {
  const val = keywordInput.value.trim().toLowerCase();
  if (val.length === 0) {
    autoCompleteList.style.display = 'none';
    updateMarkers();
    return;
  }
  const matches = shops.filter(shop =>
    shop.name.toLowerCase().includes(val) || shop.address.toLowerCase().includes(val)
  ).slice(0, 10);

  autoCompleteList.innerHTML = '';
  if (matches.length === 0) {
    autoCompleteList.style.display = 'none';
    updateMarkers();
    return;
  }
  matches.forEach(shop => {
    const li = document.createElement('li');
    li.textContent = shop.name + ' - ' + shop.address;
    li.addEventListener('mousedown', () => {
      keywordInput.value = shop.name;
      autoCompleteList.style.display = 'none';
      updateMarkers();
    });
    autoCompleteList.appendChild(li);
  });
  autoCompleteList.style.display = 'block';
});

document.addEventListener('click', e => {
  if (!keywordInput.contains(e.target) && !autoCompleteList.contains(e.target)) {
    autoCompleteList.style.display = 'none';
  }
});

keywordInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    autoCompleteList.style.display = 'none';
    updateMarkers();
  }
});

clearFiltersBtn.addEventListener('click', () => {
  document.querySelectorAll('#filter-panel input[type="checkbox"]').forEach(cb => cb.checked = false);
  selectedFilters.genre = [];
  selectedFilters.scene = [];
  selectedFilters.seat = [];
  selectedFilters.course = [];
  selectedFilters.alcohol = [];
  keywordInput.value = '';
  autoCompleteList.style.display = 'none';
  updateMarkers();
});

updateMarkers();

function normalizeArrayField(field) {
  if (!field) return [];
  return Array.isArray(field) ? field : [field];
}

function updateMarkers() {
  const keyword = keywordInput.value.trim().toLowerCase();

  markers.forEach(marker => map.removeLayer(marker));
  markers = [];

  shops.forEach(shop => {
    const shopGenre = normalizeArrayField(shop.genre);
    const shopScene = normalizeArrayField(shop.scene);
    const shopSeat = normalizeArrayField(shop.seat);
    const shopCourse = normalizeArrayField(shop.course);
    const shopAlcohol = normalizeArrayField(shop.alcohol);

    const matchesGenre = selectedFilters.genre.length === 0 || selectedFilters.genre.some(f => shopGenre.includes(f));
    const matchesscene = selectedFilters.scene.length === 0 || selectedFilters.scene.some(f => shopScene.includes(f));
    const matchesseat = selectedFilters.seat.length === 0 || selectedFilters.seat.some(f => shopSeat.includes(f));
    const matchescourse = selectedFilters.course.length === 0 || selectedFilters.course.some(f => shopCourse.includes(f));
    const matchesAlcohol = selectedFilters.alcohol.length === 0 || selectedFilters.alcohol.some(f => shopAlcohol.includes(f));

    const matchesKeyword =
      keyword === '' ||
      shop.name.toLowerCase().includes(keyword) ||
      shop.address.toLowerCase().includes(keyword);

    if (matchesGenre && matchesscene && matchesseat && matchescourse && matchesAlcohol && matchesKeyword) {
      const popupContent = `
        <div style="text-align:center; max-width: 200px;">
          <strong>${shop.name}</strong><br>
          ${shop.address}<br>
          <a href="${shop.url}" target="_blank" style="color: blue;">
            お店のページを見る
          </a>
        </div>
      `;
      const icon = icons["default"];
      const marker = L.marker([shop.lat, shop.lng], { icon })
        .addTo(map)
        .bindPopup(popupContent);
      markers.push(marker);
    }
  });
}
</script>

</body>
</html>
